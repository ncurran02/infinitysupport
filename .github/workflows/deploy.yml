name: Deploy website

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: deployment

    steps:
    - name: üì• Checkout repo
      uses: actions/checkout@v3

    - name: üß± Build React
      run: |
        npm ci
        npm run build
    
    - name: Remove files from the server
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        port: ${{ secrets.PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Checking if the directory exists on the server..."
          if [ -d "/var/www/infinitysupportservices.com.au" ]; then
            echo "Removing old files but preserving the .env file..."
            cd /var/www/infinitysupportservices.com.au
            shopt -s extglob
            find "$TARGET_DIR" -mindepth 1 ! -name '.env' -exec rm -rf {} +
            echo "Old files removed successfully."
          else
            echo "Target directory does not exist. Skipping removal."
          fi

    - name: üì§ Deploy build to server via SCP
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        port: ${{ secrets.PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "dist/*"
        target: "/var/www/infinitysupportservices.com.au/"

    - name: üßæ Upload package.json + lockfile
      uses: appleboy/scp-action@v0.1.6
      with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          port: ${{ secrets.PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./package.json,./package-lock.json"
          target: "/var/www/infinitysupportservices.com.au/"

    - name: üîÅ Reload Caddy
      uses: appleboy/ssh-action@v1
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        port: ${{ secrets.PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Reloading web service..."
          sudo npm install --omit=dev
          sudo systemctl restart infinity-web